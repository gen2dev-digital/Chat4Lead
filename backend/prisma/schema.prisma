// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Plan {
  FREE
  STARTER
  GROWTH
  BUSINESS
  ENTERPRISE
}

enum StatusEntreprise {
  TRIAL
  ACTIVE
  PAUSED
  CANCELLED
}

enum Metier {
  DEMENAGEMENT
}

enum PrioriteLead {
  CHAUD
  TIEDE
  MOYEN
  FROID
}

enum StatutLead {
  NOUVEAU
  CONTACTE
  CONVERTI
  PERDU
}

enum StatusConversation {
  ACTIVE
  QUALIFIED
  ABANDONED
  CLOSED
}

enum RoleMessage {
  user
  assistant
  system
}

model Entreprise {
  id        String           @id @default(uuid())
  nom       String
  email     String           @unique
  telephone String?
  plan      Plan             @default(FREE)
  status    StatusEntreprise @default(TRIAL)
  apiKey    String           @unique @default(uuid())
  nomBot    String           @default("Assistant")
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  configs       ConfigMetier[]
  leads         Lead[]
  conversations Conversation[]

  @@index([apiKey])
  @@index([email])
}

model ConfigMetier {
  id                      String   @id @default(uuid())
  entrepriseId            String
  metier                  Metier
  zonesIntervention       String[]
  tarifsCustom            Json
  specificites            Json
  promptCustom            String?  @db.Text
  documentsCalcul         Json?
  consignesPersonnalisees String?  @db.Text
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  entreprise Entreprise @relation(fields: [entrepriseId], references: [id], onDelete: Cascade)

  @@unique([entrepriseId, metier])
  @@index([entrepriseId])
}

model Lead {
  id               String       @id @default(uuid())
  entrepriseId     String
  prenom           String?
  nom              String?
  email            String?
  telephone        String?
  projetData       Json
  score            Int          @default(0)
  priorite         PrioriteLead @default(MOYEN)
  statut           StatutLead   @default(NOUVEAU)
  notificationSent Boolean      @default(false)
  pushedToCRM      Boolean      @default(false)
  creneauRappel    String?
  satisfaction     String?
  satisfactionScore Int?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  entreprise   Entreprise    @relation(fields: [entrepriseId], references: [id], onDelete: Cascade)
  conversation Conversation?

  @@index([entrepriseId])
  @@index([email])
  @@index([statut])
}

model Conversation {
  id           String             @id @default(uuid())
  leadId       String?            @unique
  entrepriseId String
  metier       Metier
  status       StatusConversation @default(ACTIVE)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  lead       Lead?      @relation(fields: [leadId], references: [id], onDelete: SetNull)
  entreprise Entreprise @relation(fields: [entrepriseId], references: [id], onDelete: Cascade)
  messages   Message[]

  @@index([entrepriseId])
  @@index([status])
}

model Message {
  id             String      @id @default(uuid())
  conversationId String
  role           RoleMessage
  content        String      @db.Text
  tokensUsed     Int?
  latencyMs      Int?
  createdAt      DateTime    @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}

model ConversationCache {
  id                String   @id @default(uuid())
  metier            Metier
  questionEmbedding String   @db.Text
  response          String   @db.Text
  usageCount        Int      @default(0)
  createdAt         DateTime @default(now())

  @@index([metier])
}
