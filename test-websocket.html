<!DOCTYPE html>
<html>

<head>
    <title>Test WebSocket Chat4Lead</title>
    <style>
        body {
            font-family: sans-serif;
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            background: #f4f7f6;
        }

        #chat-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        #messages {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
        }

        .msg {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 18px;
            max-width: 80%;
            line-height: 1.4;
        }

        .user-msg {
            align-self: flex-end;
            background: #007bff;
            color: white;
            border-bottom-right-radius: 2px;
        }

        .bot-msg {
            align-self: flex-start;
            background: #e9ecef;
            color: #333;
            border-bottom-left-radius: 2px;
        }

        .bot-typing {
            align-self: flex-start;
            font-style: italic;
            font-size: 0.9em;
            color: #777;
            margin-bottom: 10px;
        }

        .error-msg {
            color: #dc3545;
            font-size: 0.85em;
            margin: 5px 0;
            text-align: center;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        #messageInput {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            outline: none;
        }

        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover {
            background: #0056b3;
        }

        .status {
            font-size: 0.8em;
            margin-bottom: 10px;
            color: #666;
        }

        .score-badge {
            display: inline-block;
            font-size: 0.7em;
            background: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 10px;
        }
    </style>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
</head>

<body>
    <div id="chat-container">
        <h1>Test WebSocket Gateway</h1>
        <div id="status" class="status">Connexion en cours...</div>
        <div id="messages"></div>
        <div id="typing" class="bot-typing" style="display: none;">Tom est en train d'Ã©crire...</div>
        <div class="controls">
            <input id="messageInput" type="text" placeholder="Entrez votre message ici..."
                onkeypress="if(event.key === 'Enter') sendMessage()" />
            <button onclick="sendMessage()">Envoyer</button>
        </div>
    </div>

    <script>
        const API_KEY = '2b76dd8a-8206-4354-9ea6-cf4a8916c11e';
        const CONV_ID = 'cc273ed6-2f81-4262-ab96-4722ccaa43cb';

        const statusEl = document.getElementById('status');
        const messagesEl = document.getElementById('messages');
        const typingEl = document.getElementById('typing');
        const inputEl = document.getElementById('messageInput');

        const socket = io('http://localhost:3000', {
            auth: { apiKey: API_KEY },
            transports: ['websocket']
        });

        socket.on('connect', () => {
            statusEl.innerHTML = `âœ… ConnectÃ© | Socket ID: ${socket.id}`;
            statusEl.style.color = 'green';
            console.log('âœ… ConnectÃ© !', socket.id);
            socket.emit('join-conversation', { conversationId: CONV_ID });
        });

        socket.on('connect_error', (err) => {
            statusEl.innerHTML = `âŒ Erreur de connexion: ${err.message}`;
            statusEl.style.color = 'red';
            console.error('âŒ Erreur:', err);
        });

        socket.on('disconnect', () => {
            statusEl.innerHTML = 'ðŸ”Œ DÃ©connectÃ©';
            statusEl.style.color = 'gray';
        });

        socket.on('bot-typing', () => {
            typingEl.style.display = 'block';
            messagesEl.scrollTop = messagesEl.scrollHeight;
        });

        socket.on('bot-message', (data) => {
            typingEl.style.display = 'none';
            const scoreHtml = data.score ? `<span class="score-badge">Score: ${data.score}/100</span>` : '';
            addMessage(`<strong>Tom:</strong> ${data.reply}${scoreHtml}`, 'bot-msg');
            console.log('ðŸ¤– Bot response:', data);
        });

        socket.on('bot-error', (data) => {
            typingEl.style.display = 'none';
            const errDiv = document.createElement('div');
            errDiv.className = 'error-msg';
            errDiv.innerHTML = `Erreur: ${data.error}`;
            messagesEl.appendChild(errDiv);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        });

        function addMessage(html, className) {
            const div = document.createElement('div');
            div.className = `msg ${className}`;
            div.innerHTML = html;
            messagesEl.appendChild(div);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function sendMessage() {
            const message = inputEl.value.trim();
            if (!message) return;

            addMessage(message, 'user-msg');
            socket.emit('send-message', { conversationId: CONV_ID, message });
            inputEl.value = '';
        }
    </script>
</body>

</html>